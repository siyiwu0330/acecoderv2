# Skip Step4 功能使用说明

## 🎯 功能概述

为了解决大量问题（problem）时在第二轮结尾卡住的问题，我们添加了 `skip_step4` 参数来控制是否跳过第四步（交叉轮次评估）。

## 🚀 使用方法

### 1. 命令行使用

```bash
# 跳过第四步（推荐用于大数据集）
python main.py --output_dir outputs/test --rounds 2 --max_samples 100 --skip_step4 True

# 不跳过第四步（默认行为）
python main.py --output_dir outputs/test --rounds 2 --max_samples 100 --skip_step4 False

# 或者不指定（默认为 False）
python main.py --output_dir outputs/test --rounds 2 --max_samples 100
```

### 2. Gradio 界面使用

1. 启动 Gradio 界面：
   ```bash
   python integrated_gradio_app.py
   ```

2. 在 "🚀 Pipeline Control" 标签页中：
   - 找到 "⏭️ Skip Step 4 (Cross-Round Evaluation)" 复选框
   - 勾选此选项以跳过第四步
   - 点击 "🚀 Start Pipeline" 开始运行

## 📊 功能对比

| 功能 | skip_step4=False | skip_step4=True |
|------|------------------|-----------------|
| **核心对抗生成** | ✅ 完整 | ✅ 完整 |
| **程序进化** | ✅ 完整 | ✅ 完整 |
| **测试用例进化** | ✅ 完整 | ✅ 完整 |
| **基础可视化** | ✅ 完整 | ✅ 完整 |
| **综合矩阵** | ✅ 预计算 | ⚠️ 实时计算 |
| **性能** | ⚠️ 可能卡死 | ✅ 稳定 |
| **适用场景** | 小数据集 | 大数据集 |

## ⚡ 性能影响

### 跳过第四步的优势：
- ✅ **解决卡死问题**：避免大量问题时的资源耗尽
- ✅ **更快完成**：跳过耗时的交叉评估
- ✅ **内存友好**：减少内存使用
- ✅ **稳定运行**：避免超时和进程阻塞

### 跳过第四步的影响：
- ⚠️ **可视化降级**：综合矩阵需要实时计算
- ⚠️ **稍慢的界面**：大型数据集的可视化可能稍慢
- ✅ **功能完整**：所有核心功能仍然可用

## 🎯 推荐使用场景

### 使用 `skip_step4=True` 的情况：
- 📊 **大数据集**：问题数量 > 50
- ⏱️ **时间敏感**：需要快速完成实验
- 💾 **资源有限**：内存或CPU受限
- 🔄 **批量实验**：需要稳定运行多个实验

### 使用 `skip_step4=False` 的情况：
- 📊 **小数据集**：问题数量 < 20
- 🎨 **完整可视化**：需要最佳的可视化体验
- 🔬 **详细分析**：需要完整的交叉评估数据
- 💻 **资源充足**：有足够的内存和计算资源

## 🛠️ 技术细节

### 修改的文件：
1. **main.py**：添加 `skip_step4` 参数和条件逻辑
2. **integrated_gradio_app.py**：添加界面选项和参数传递

### 第四步的作用：
- 交叉评估所有轮次的程序 vs 所有轮次的测试用例
- 生成完整的评估矩阵用于可视化
- 计算复杂度：O(问题数 × 程序数 × 测试数)

### 跳过后的行为：
- 可视化系统自动降级到实时计算模式
- 使用 `visualization_history.jsonl` 中的数据
- 功能基本完整，性能稍慢但稳定

## 🚨 注意事项

1. **首次使用**：建议先用小数据集测试
2. **可视化**：跳过第四步后，大型数据集的可视化可能稍慢
3. **兼容性**：与现有代码完全兼容
4. **可逆性**：可以随时重新运行第四步

## 📝 示例命令

```bash
# 快速测试（小数据集，不跳过）
python main.py --rounds 2 --max_samples 10

# 生产运行（大数据集，跳过第四步）
python main.py --rounds 6 --max_samples 200 --skip_step4 True

# 完整分析（小数据集，不跳过）
python main.py --rounds 4 --max_samples 30 --skip_step4 False
```

## 🎉 总结

`skip_step4` 功能是一个实用的优化选项，特别适合处理大数据集。它解决了卡死问题，同时保持了核心功能的完整性。建议根据数据集大小和资源情况选择合适的设置。

